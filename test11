resource "google_monitoring_alert_policy" "vm_high_memory_alert" {
  display_name = "VM High Memory Alert"
  combiner     = "OR"
  enabled      = true
  project      = var.project_id

  notification_channels = [
    "projects/${var.project_id}/notificationChannels/11076007616266814838"
  ]

  # Condition 1: VM Memory > 80%
  conditions {
    display_name = "VM Memory Utilization > 80%"

    condition_threshold {
      filter = <<EOT
resource.type = "gce_instance"
AND metric.type = "agent.googleapis.com/memory/percent_used"
AND metric.labels.state = "used"
AND NOT metadata.system_labels.name = monitoring.regex.full_match("nongo.*")
EOT
      duration         = "300s"
      comparison       = "COMPARISON_GT"
      threshold_value  = 80

      aggregations {
        alignment_period   = "300s"
        per_series_aligner = "ALIGN_MEAN"
      }

      trigger {
        count = 1
      }
    }
  }

  # Condition 2: VM Memory > 90%
  conditions {
    display_name = "VM Memory Utilization > 90%"

    condition_threshold {
      filter = <<EOT
resource.type = "gce_instance"
AND metric.type = "agent.googleapis.com/memory/percent_used"
AND metric.labels.state = "used"
AND NOT metadata.system_labels.name = monitoring.regex.full_match("nongo.*")
EOT
      duration         = "300s"
      comparison       = "COMPARISON_GT"
      threshold_value  = 90

      aggregations {
        alignment_period   = "300s"
        per_series_aligner = "ALIGN_MEAN"
      }

      trigger {
        count = 1
      }
    }
  }

  # âœ… New Condition 3: Node Memory > 50%
  conditions {
    display_name = "Kubernetes Node - Memory allocatable utilization exceeded 50%"

    condition_threshold {
      filter          = "resource.type = \"k8s_node\" AND metric.type = \"kubernetes.io/node/memory/allocatable_utilization\""
      duration        = "0s"
      comparison      = "COMPARISON_GT"
      threshold_value = 0.5

      aggregations {
        alignment_period   = "300s"
        per_series_aligner = "ALIGN_MAX"
      }

      trigger {
        count = 1
      }
    }
  }

  alert_strategy {
    auto_close = "86400s"
  }

  documentation {
    content = <<EOT
{
  "severity": "WARNING",
  "text": "VM memory or Kubernetes node memory utilization has crossed thresholds.",
  "object": "VMMemory | NodeMemory",
  "@key": "6b89d199-64cd-4ec4-ab7d-7514c92283be",
  "@version": "alertapi-0.1",
  "@type": "ALERT"
}
EOT
    mime_type = "text/markdown"
  }

  user_labels = {}
}
