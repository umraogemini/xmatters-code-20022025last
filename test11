# =====================================================
# Cloud SQL Memory Utilization Alert Policy (> 70%)
# =====================================================
resource "google_monitoring_alert_policy" "cloud_sql_memory_utilization" {
  display_name = "Cloud SQL Memory > 70%-orchestration"
  combiner     = "OR"
  enabled      = true
  project      = var.project_id

  notification_channels = [
    "projects/${var.project_id}/notificationChannels/6932552353813421384",
    "projects/${var.project_id}/notificationChannels/17221980647596614643",
    "projects/${var.project_id}/notificationChannels/14109700884803400142",
    "projects/${var.project_id}/notificationChannels/16584411114958775631"
  ]

  conditions {
    display_name = "Cloud SQL Database - Memory utilization exceeded 70%"

    condition_threshold {
      filter = <<EOT
resource.type = "cloudsql_database"
AND (resource.labels.database_id = monitoring.regex.full_match(".*ecosystem-orchestration.*")
AND resource.labels.database_id != monitoring.regex.full_match(".*ecosystem-orchestration-sit.*"))
AND metric.type = "cloudsql.googleapis.com/database/memory/utilization"
EOT
      duration        = "0s"
      comparison      = "COMPARISON_GT"
      threshold_value = 70

      aggregations {
        alignment_period   = "300s"
        per_series_aligner = "ALIGN_MEAN"
      }

      trigger {
        count = 1
      }
    }
  }

  alert_strategy {
    auto_close = "86400s" # 1 day
  }

  documentation {
    content = <<EOT
{
  "severity": "WARNING",
  "text": "Cloud SQL Memory utilization exceeded threshold.\\nmetric: \${metric.type}\\nproject.id: \${resource.label.project_id}\\nregion: \${resource.label.region}\\ndatabase_id: \${resource.label.database_id}\\ndatabase: \${resource.label.database}",
  "object": "CloudSQLMemory",
  "@key": "e85de96c-8c9e-49b4-a9c8-a1bac79c7435",
  "@version": "alertapi-0.1",
  "@type": "ALERT"
}
EOT
    mime_type = "text/markdown"
  }

  user_labels = {}
}
